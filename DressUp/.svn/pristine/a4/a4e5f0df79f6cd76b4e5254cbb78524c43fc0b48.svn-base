import { Core, UIBase, TweenMgr, DataMgr, EventMgr, GameMgr, UIMgr, SceneMgr } from "../../Frame/Core";

import Util from "../../Frame/Util";
import ADManager, { TaT } from "../../Admanager";
import GameDataController from "../GameDataController";
import ClothChange from "../ClothChange";
import BagListController from "./Bag/BagListController";
import RecordManager from "../../RecordManager";


export default class UIReady extends UIBase
{
    static Instance: UIReady;
    ClothOpenBtn: Laya.Image;//打开装扮栏
    ADBG: Laya.Label;
    BtnBar: Laya.Box;//导航栏
    ShowView: Laya.Box;//装扮栏

    clothisopen = true;

    Ubag: Core.Tween.Tweener;
    Dbag: Core.Tween.Tweener;
    Rbtn: Core.Tween.Tweener;
    Lbtn: Core.Tween.Tweener;
    btnU: Core.Tween.Tweener;
    btnD: Core.Tween.Tweener;
    FRS: Core.Tween.Tweener;
    FRB: Core.Tween.Tweener;

    FRD:Core.Tween.Tweener;
    FRU:Core.Tween.Tweener;
    // FRL:Core.Tween.Tweener;
    // FRR:Core.Tween.Tweener;


    windowwidth: number;
    windowheight: number;
    FemaleRoot: Laya.Box;

    ClockBtn:Laya.Image;//闹钟
    scaleDelta:number=0;

    scaleDelta1:number=0;//分享
    //BlindBox:Laya.Image;
    Wing:Laya.Image;//翅膀彩蛋按钮

    newmap: Map<string, number> = new Map<string, number>()

    BagAll: Laya.Box;

    ClothReceive: Laya.Image;//重置
    //Area:Laya.Image;
    BG:Laya.Image;
    oldY:number=0;
    oldX:number=0;
    isLeftMove:boolean=false;

    FenxiangBtn:Laya.Image;
    MusicBtn:Laya.Image;
    isMusicing:boolean=false;

    oldTime:number=0;

    str={};
    str1={};
    onInit()
    {
        ADManager.TAPoint(TaT.PageEnter,"mainpage");

        UIMgr.show("UIRecommend");//每日推荐

        //Laya.LocalStorage.clear();
        this.BG=this.vars("BG")as Laya.Image;
        this.BG.on(Laya.Event.MOUSE_DOWN,this,this.onMouseDownListen)
        this.BG.on(Laya.Event.MOUSE_UP,this,this.onMouseUpListen)
        this.BG.on(Laya.Event.MOUSE_OUT, this,this.onMouseOutListen);

        // this.BlindBox=this.vars("BlindBox")as Laya.Image;
        // this.BlindBox.on(Laya.Event.CLICK,this,()=>{
        //     UIMgr.show("UIBlindBox");
        // });
        this.Wing=this.vars("Wing") as Laya.Image;
        Laya.timer.frameLoop(1,this,()=>{
            this.scaleDelta+=0.02;
            var scaleValue:number=Math.sin(this.scaleDelta);
            this.Wing.scale(scaleValue,1); 
        })
        this.Wing.on(Laya.Event.CLICK,this,()=>{
                UIMgr.show("UIWing");
                this.Wing.visible=false;
        });
        this.windowheight = Laya.Browser.height;
        this.windowwidth = Laya.Browser.width;
        if (Laya.LocalStorage.getItem("Sign"))
        {

        }
        else
        {
            GameDataController.setFirstLoginTime();
        }

        this.btnEv("ClothOpenBtn", this.ClothOpenBtnClick);
        this.btnEv("ActiveBtn", this.ActiveClick);
        this.btnEv("ClothReceive", () =>
        {
            ADManager.TAPoint(TaT.BtnClick,"chongzhi_click");
            ClothChange.Instance.ClothReceive();
            BagListController.Instance.ClothesPageChange(BagListController.Instance.SelectIndex)
        });
        this.btnEv("PhotoBtn", () =>
        {
            UIMgr.show("UIPhotos");
            ADManager.TAPoint(TaT.BtnClick,"xiangce_click");
        });
        this.btnEv("Share", () =>
        {
            ClothChange.Instance.Share();
            ADManager.TAPoint(TaT.BtnClick,"paizhao_click");
        });


        //xxxxxxxxxxxxxxxxxxxxxxx
        this.ClockBtn = this.vars("ClockBtn");
        var current:Date=new Date();
        var hour=current.getHours()
        if (hour>=12&&hour<=14) {
            this.ClockBtn.visible=true;
            Laya.timer.frameLoop(1,this,()=>{
                this.scaleDelta+=0.02;
                var scaleValue:number=Math.sin(this.scaleDelta);
                this.ClockBtn.scale(scaleValue,scaleValue);
            })
        }
        else{
            this.ClockBtn.visible=false;
        }
        this.btnEv("ClockBtn",()=>{
            UIMgr.show("UITest");
        });
        //xxxxxxxxxxxxxxxxxxxxxxx
        this.ShowView = this.vars("ShowView");
        this.BtnBar = this.vars("BtnBar");
        this.ClothOpenBtn = this.vars("ClothOpenBtn");

        this.FemaleRoot = this.vars("FemaleRoot");

        this.BagAll = this.vars("BagALL");
        this.Ubag = TweenMgr.tweenCust(300, this, this.tweenbagUp, null, true, Laya.Ease.linearNone);
        this.Lbtn = TweenMgr.tweenCust(300, this, this.tweenbtnLeft, null, true, Laya.Ease.linearNone);
        this.btnU = TweenMgr.tweenCust(200, this, this.RoteUp, null, true, Laya.Ease.linearNone);
        this.FRS = TweenMgr.tweenCust(300, this, this.tweenFBTSmall, null, true, Laya.Ease.linearNone);

        this.Dbag = TweenMgr.tweenCust(300, this, this.tweenbagDown, null, true, Laya.Ease.backOut);
        this.Rbtn = TweenMgr.tweenCust(300, this, this.tweenbtnRight, null, true, Laya.Ease.backOut);
        this.btnD = TweenMgr.tweenCust(200, this, this.RoteDown, null, true, Laya.Ease.linearNone);
        this.FRB = TweenMgr.tweenCust(300, this, this.tweenFBTBig, null, true, Laya.Ease.backOut);

        this.FRD = TweenMgr.tweenCust(300, this, this.tweenFRToDown, null, true, Laya.Ease.backOut);
        this.FRU = TweenMgr.tweenCust(300, this, this.tweenFRToUp, null, true, Laya.Ease.backOut);
        // this.FRL = TweenMgr.tweenCust(300, this, this.tweenFRToLeft, null, true, Laya.Ease.backOut);
        // this.FRR = TweenMgr.tweenCust(300, this, this.tweenFRToRight, null, true, Laya.Ease.backOut);

        //每日签到
        // console.log("this.newmap", GameDataController.ClothDataAsy);
        // if (GameDataController.IsNewDay())
        // {
        //     console.log("GameDataController.IsNewDay", GameDataController.TodaySign);
        //     GameDataController.TodaySign = "0";
        // }
        // let havesign = GameDataController.TodaySign;
        // if (havesign)
        // {
        //     if (havesign == "1")
        //     {

        //     }
        //     else
        //     {
        //         UIMgr.show("UISign");
               
        //     }
        // }
        // else
        // {
        //     UIMgr.show("UISign");
        //     GameDataController.TodaySign = "0";
        // }
        


        

        this.MusicBtn=this.vars("MusicBtn")as Laya.Image;
        Laya.SoundManager.playSound("res/sounds/CCBGM.mp3",0);
            Laya.timer.frameLoop(1, this, this.MusicRot);
        this.btnEv("MusicBtn",()=>{
            if(!this.isMusicing)
            {
                console.log("xxxxxxxxxxxxxxxxxx1");
                this.isMusicing=true;
                Laya.SoundManager.playSound("res/sounds/CCBGM.mp3",0);
                Laya.timer.frameLoop(1, this, this.MusicRot);
                let a= this.MusicBtn.getChildByName("No")as Laya.Image;
                a.visible=false;
            }
            else
            {
                console.log("xxxxxxxxxxxxxxxxxx2");
                this.isMusicing=false;
                Laya.SoundManager.stopSound("res/sounds/CCBGM.mp3");
                Laya.timer.clear(this,this.MusicRot);
                let a= this.MusicBtn.getChildByName("No")as Laya.Image;
                a.visible=true;
            }
        })


        this.FenxiangBtn=this.vars("FenxiangBtn")as Laya.Image;

    
        this.btnEv("FenxiangBtn",()=>{
            RecordManager.stopAutoRecord();
            RecordManager._share(()=>{
                UIMgr.tip("分享成功");
                this.FenxiangBtn.visible=false;
            },()=>{
                this.FenxiangBtn.visible=false;
            });
            Laya.timer.once(5000,this,this.Record);
            
        })




        //更新橱窗套装信息
        GameDataController.ClothPackge2.cloths1.forEach((v, i) =>
        {
        let nv = GameDataController.ClothDataRefresh[GameDataController.ClothPackge2.cloths1[i].ID]//0 解锁 1未解锁
        this.str[GameDataController.ClothPackge2.cloths1[i].ID] = nv;
        });
        GameDataController.ClothdatapackSet(GameDataController.ClothPackge2.cloths1[0].GetType2, this.str)//更新套装信息
        GameDataController.ClothPackge2.cloths2.forEach((v, i) =>
        {
        let nv = GameDataController.ClothDataRefresh[GameDataController.ClothPackge2.cloths2[i].ID]//0 解锁 1未解锁
        this.str1[GameDataController.ClothPackge2.cloths2[i].ID] = nv;
        });
        GameDataController.ClothdatapackSet(GameDataController.ClothPackge2.cloths2[0].GetType2, this.str1)//更新套装信息
    }
    MusicRot()
    {
        this.MusicBtn.rotation+=2;
    }
    
    ActiveClick()
    {
        UIMgr.show("UIActive");
    }

    buyFun()
    {

    }
    RefreshUI()
    {

    }

    Record()
    {
        console.log("开始录屏。。。。。。。。。。");
        RecordManager.startAutoRecord();
        Laya.timer.loop(30000,this,this.RecordLoop);

    }

    RecordLoop()
    {
        console.log("执行了.......................");  
        RecordManager.stopAutoRecord();
        this.FenxiangBtn.visible=true;
        this.FenxiangBtnShake()
        RecordManager.startAutoRecord();
    }


    FenxiangBtnShake()
    {
        Laya.timer.frameLoop(1,this,()=>{
            this.scaleDelta1+=0.02;
            var scaleValue:number=Math.sin(this.scaleDelta);
            this.FenxiangBtn.scale(scaleValue,1);
        })
    }

    onShow()
    {
        this.RefreshUI();
  
        Laya.timer.once(10000,this,this.Record);
          

        //UIMgr.show("UISign");
    }

    onHide()
    {

    }
    ClothOpenBtnClick()
    {
        if (this.clothisopen)
        {
            ADManager.TAPoint(TaT.BtnClick,"fangda_click");
            console.log("消失");
            this.Dbag.play();
            //this.Rbtn.play();
            this.btnU.play();
            this.FRB.play();
            let a: Map<string, number> = Laya.LocalStorage.getJSON("ClothData");


        }
        else
        {
            console.log("展示");
            //this.Lbtn.play();
            this.Ubag.play();
            this.btnD.play();
            this.FRS.play();
        }
        this.clothisopen = !this.clothisopen;
    }
    RoteDown(t: Core.Tween.Tweener)
    {
        let nbtm: number = this.ClothOpenBtn.rotation;
        TweenMgr.lerp_Num(nbtm, 180, t);
        this.ClothOpenBtn.rotation = t.outParams[0][0];
    }
    RoteUp(t: Core.Tween.Tweener)
    {
        let nbtm: number = this.ClothOpenBtn.rotation;
        TweenMgr.lerp_Num(nbtm, 0, t);
        this.ClothOpenBtn.rotation = t.outParams[0][0];
    }


    tweenbagUp(t: Core.Tween.Tweener)
    {
        let nbtm: number = this.BagAll.bottom;
        TweenMgr.lerp_Num(nbtm, 0, t);
        this.BagAll.bottom = t.outParams[0][0];
    }
    tweenbagDown(t: Core.Tween.Tweener)
    {
        let nbtm: number = this.BagAll.bottom;
        TweenMgr.lerp_Num(nbtm, -485, t);
        this.BagAll.bottom = t.outParams[0][0];
    }
    tweenbtnLeft(t: Core.Tween.Tweener)
    {
        let nX: number = this.BtnBar.x;
        TweenMgr.lerp_Num(nX, 75, t);
        this.BtnBar.x = t.outParams[0][0];
    }
    tweenbtnRight(t: Core.Tween.Tweener)
    {
        let nX: number = this.BtnBar.x;
        TweenMgr.lerp_Num(nX, GameDataController.windowWidth - 75, t);
        this.BtnBar.x = t.outParams[0][0];
    }

    tweenFBTSmall(t: Core.Tween.Tweener)
    {
        let nX: number = this.FemaleRoot.scaleX;
        TweenMgr.lerp_Num(nX, 0.8, t);
        this.FemaleRoot.scaleX = this.FemaleRoot.scaleY = t.outParams[0][0];
        this.BG.on(Laya.Event.MOUSE_DOWN,this,this.onMouseDownListen)
        
    }
    tweenFBTBig(t: Core.Tween.Tweener)
    {
        let nX: number = this.FemaleRoot.scaleX;
        TweenMgr.lerp_Num(nX, 1.2, t);
        this.FemaleRoot.scaleX = this.FemaleRoot.scaleY = t.outParams[0][0];
        this.BG.off(Laya.Event.MOUSE_DOWN,this,this.onMouseDownListen)
    }
    onClick_Btnshortcut()
    {
        UIMgr.show("UIMain");
    }

    onMouseMoveListen(e:Laya.Event)
    {
       if(this.BG.mouseY>this.oldY)
       {          
           if(this.BG.mouseY-this.oldY>200)
           {
                console.log("下滑");
                this.FRD.play(); 
                if(!this.Wing.visible&&GameDataController.ClothDataRefresh[50404]==1)
               {
                   this.Wing.visible=true;
               }
           }
       }
       if(this.BG.mouseX<this.oldX)
       {
           if(this.oldX-this.BG.mouseX>150)
           {
               console.log("oldX"+this.oldX);
               console.log(this.BG.mouseX);
               console.log("左滑"+(this.oldX-this.BG.mouseX));
               //this.FRL.play();
            //    if(!this.BlindBox.visible)
            //    {
            //        this.BlindBox.visible=true;
            //    }
           }
       }
    }
    onMouseDownListen()
    {
        this.oldY=this.BG.mouseY;
        this.oldX=this.BG.mouseX;
        this.BG.on(Laya.Event.MOUSE_MOVE,this,this.onMouseMoveListen);
    }
    onMouseUpListen()
    {
        console.log("鼠标抬起");
        this.BG.off(Laya.Event.MOUSE_MOVE,this,this.onMouseMoveListen);
        this.FRU.play();
        //this.FRR.play();

    }
    onMouseOutListen()
    {
        console.log("不在目标区域");
        this.FRU.play();
        //this.FRR.play();

        this.BG.off(Laya.Event.MOUSE_MOVE,this,this.onMouseMoveListen);
    }

    tweenFRToDown(t:Core.Tween.Tweener)
    {
        TweenMgr.lerp_Num(this.FemaleRoot.centerY,-60,t);
        this.FemaleRoot.centerY = t.outParams[0][0];
    }
    tweenFRToUp(t:Core.Tween.Tweener)
    {
        TweenMgr.lerp_Num(this.FemaleRoot.centerY, -193, t);
        this.FemaleRoot.centerY = t.outParams[0][0];
    }
    // tweenFRToLeft(t:Core.Tween.Tweener)
    // {
    //     TweenMgr.lerp_Num(this.FemaleRoot.centerX,-100,t);
    //     this.FemaleRoot.centerX=t.outParams[0][0];
    // }
    // tweenFRToRight(t:Core.Tween.Tweener)
    // {
    //     TweenMgr.lerp_Num(this.FemaleRoot.centerX,-12,t);
    //     this.FemaleRoot.centerX=t.outParams[0][0];
    //     this.isLeftMove=true;
    // }

}